#include <Eigen\Eigen>
#include <iostream>
#include <fstream>
#include <random>

std::random_device rd;
std::mt19937 gen(rd());

double m1data[] = { -0.068008, -0.10828, -0.18429, -0.28122, -0.38059, -0.46734, -0.51377, -0.48184, -0.36064, -0.18839, -0.0217, 0.10187, 0.161, 0.15236, 0.1139, 0.095567, 0.094471, 0.071562, 0.036262, 0.056372, 0.16257, 0.28877, 0.34268, 0.30591, 0.23398, 0.18175, 0.15085, 0.10005, 0.0075795, -0.07894,
-0.11028, -0.12539, -0.16074, -0.21886, -0.29962, -0.39235, -0.45943, -0.44986, -0.34461, -0.18127, -0.022587, 0.088775, 0.13636, 0.12739, 0.1025, 0.10427, 0.12369, 0.12117, 0.10014, 0.11243, 0.18035, 0.25298, 0.26468, 0.21012, 0.13898, 0.095698, 0.075987, 0.03412, -0.055524, -0.1436,
-0.11379, -0.10571, -0.10124, -0.11957, -0.18054, -0.27861, -0.36561, -0.37713, -0.28618, -0.13085, 0.01699, 0.10703, 0.13063, 0.11256, 0.098844, 0.12044, 0.15892, 0.17655, 0.17205, 0.17557, 0.19486, 0.19737, 0.15313, 0.073932, 0.00073898, -0.03513, -0.043064, -0.072386, -0.15422, -0,
-0.037303, -0.028957, -0.017015, -0.021547, -0.070684, -0.16354, -0.25072, -0.26542, -0.17877, -0.029358, 0.1043, 0.16534, 0.15311, 0.11209, 0.09642, 0.12539, 0.16976, 0.19503, 0.20026, 0.19835, 0.18197, 0.13103, 0.043688, -0.056206, -0.13595, -0.17177, -0.17117, -0.18269, -0.2444,
0.066681, 0.055131, 0.045459, 0.032732, -0.0066325, -0.077555, -0.14261, -0.14558, -0.059924, 0.079669, 0.19536, 0.22609, 0.17438, 0.099645, 0.066849, 0.090575, 0.13277, 0.15836, 0.1666, 0.16175, 0.12897, 0.055295, -0.048023, -0.15556, -0.24104, -0.27907, -0.26718, -0.24924, -0.27226, -0.31625,
0.11543, 0.082219, 0.047041, 0.024374, 0.0007678, -0.035986, -0.068627, -0.05761, 0.022666, 0.14853, 0.2501, 0.26238, 0.18125, 0.070406, 0.0070234, 0.013609, 0.051444, 0.079264, 0.088405, 0.078761, 0.040072, -0.030773, -0.1205, -0.2138, -0.29261, -0.32536, -0.29541, -0.23937, -0.21264, -0.21849,
0.091865, 0.04822, 0.00071924, -0.023109, -0.027385, -0.030299, -0.033985, -0.01443, 0.055597, 0.16752, 0.26394, 0.27645, 0.18655, 0.050085, -0.047709, -0.067463, -0.037443, -0.0053762, 0.003353, -0.017789, -0.064924, -0.12224, -0.17622, -0.23028, -0.28216, -0.29884, -0.25142, -0.1663, -0.10062, -0.075208,
0.056099, 0.013574, -0.03367, -0.055034, -0.048378, -0.032731, -0.021234, -0.0012362, 0.053988, 0.14827, 0.23959, 0.26296, 0.1872, 0.05155, -0.063222, -0.10529, -0.08629, -0.052986, -0.047148, -0.085152, -0.14763, -0.19357, -0.20493, -0.20579, -0.21753, -0.21608, -0.16645, -0.081474, -0.0086513, 0.026714,
0.069928, 0.036179, -0.0043665, -0.027914, -0.029351, -0.021166, -0.015443, -0.0062744, 0.026203, 0.090754, 0.16337, 0.19506, 0.1523, 0.053999, -0.040099, -0.081733, -0.068853, -0.037058, -0.033704, -0.084192, -0.16016, -0.1994, -0.17663, -0.13178, -0.11027, -0.10397, -0.078093, -0.030167, 0.011907, 0.031992,
0.12554, 0.10585, 0.076263, 0.046847, 0.023384, 0.0052152, -0.010516, -0.022196, -0.02216, -0.0026408, 0.032449, 0.061322, 0.059615, 0.027051, -0.0088649, -0.019357, 0.0023669, 0.036737, 0.043502, -0.0059952, -0.08215, -0.11377, -0.071967, -0.0052042, 0.026191, 0.016792, -0.0023847, -0.016384, -0.030614, -0.043535,
0.15914, 0.15491, 0.13959, 0.11053, 0.07445, 0.040741, 0.011913, -0.018002, -0.05419, -0.089457, -0.10693, -0.09771, -0.07027, -0.038237, -0.0053082, 0.032701, 0.07878, 0.12519, 0.14374, 0.10919, 0.049034, 0.030841, 0.078896, 0.14221, 0.16029, 0.12441, 0.06082, -0.011038, -0.08039, -0.12772,
0.1299, 0.13647, 0.13479, 0.11875, 0.098434, 0.084921, 0.072513, 0.040814, -0.024013, -0.1098, -0.18144, -0.20618, -0.17801, -0.1159, -0.041645, 0.033374, 0.106, 0.17072, 0.20664, 0.19497, 0.16129, 0.16083, 0.2056, 0.24732, 0.24073, 0.18567, 0.10332, 0.0072078, -0.088139, -0.15325,
0.063372, 0.073128, 0.079915, 0.083253, 0.097706, 0.12843, 0.15221, 0.13291, 0.055717, -0.05679, -0.15865, -0.21006, -0.20245, -0.15576, -0.090833, -0.014807, 0.068926, 0.14845, 0.20074, 0.21205, 0.20622, 0.22119, 0.25308, 0.2624, 0.23092, 0.17448, 0.10774, 0.030009, -0.052302, -0.1111,
0.015049, 0.022621, 0.031544, 0.048372, 0.089509, 0.15282, 0.20193, 0.19382, 0.12093, 0.017667, -0.06944, -0.11416, -0.12408, -0.12193, -0.11032, -0.07041, 0.0034993, 0.087855, 0.14936, 0.17695, 0.19263, 0.21537, 0.22592, 0.19835, 0.14597, 0.10129, 0.070817, 0.036827, -0.0079391, -0.044493,
0.023348, 0.025521, 0.03089, 0.049713, 0.095204, 0.16021, 0.20711, 0.19846, 0.13828, 0.069644, 0.031853, 0.024644, 0.011384, -0.035665, -0.091141, -0.099509, -0.043138, 0.039479, 0.10213, 0.13667, 0.16444, 0.18726, 0.17322, 0.10999, 0.037747, 0.0020148, 0.0031875, 0.010871, 0.0052856, -0.0065589,
0.098843, 0.091901, 0.08866, 0.10165, 0.13647, 0.18128, 0.20522, 0.18355, 0.13049, 0.092569, 0.099995, 0.12772, 0.11349, 0.028593, -0.074028, -0.11016, -0.059183, 0.02406, 0.084546, 0.1195, 0.15042, 0.16644, 0.12832, 0.033881, -0.060932, -0.10309, -0.091969, -0.060976, -0.038222, -0.029856,
0.20776, 0.1905, 0.17858, 0.18709, 0.2112, 0.23193, 0.22598, 0.18177, 0.12001, 0.086865, 0.10654, 0.14061, 0.11614, 0.011493, -0.10153, -0.13067, -0.065861, 0.025006, 0.086291, 0.12033, 0.14561, 0.14443, 0.080649, -0.038237, -0.15291, -0.21158, -0.20978, -0.17516, -0.13877, -0.11806,
0.26056, 0.23948, 0.22892, 0.24424, 0.26893, 0.2754, 0.24538, 0.17721, 0.09516, 0.044846, 0.04993, 0.070558, 0.036157, -0.065058, -0.1561, -0.15581, -0.07038, 0.029168, 0.094567, 0.12808, 0.1382, 0.10674, 0.014963, -0.11551, -0.23281, -0.3004, -0.31521, -0.29528, -0.26622, -0.2476,
0.18333, 0.1688, 0.17313, 0.20799, 0.24679, 0.25562, 0.21856, 0.13794, 0.038352, -0.032938, -0.045543, -0.030809, -0.051833, -0.11872, -0.16683, -0.13667, -0.044433, 0.050129, 0.11269, 0.14065, 0.12811, 0.061742, -0.050095, -0.16967, -0.26229, -0.32108, -0.35324, -0.36503, -0.36593, -0.36543,
0.012717, 0.0085006, 0.030183, 0.084306, 0.13958, 0.16145, 0.13481, 0.058938, -0.046309, -0.13102, -0.15088, -0.11925, -0.090919, -0.089457, -0.081973, -0.035, 0.037381, 0.10043, 0.13982, 0.15021, 0.11449, 0.026343, -0.08199, -0.16411, -0.20966, -0.24644, -0.29391, -0.34299, -0.37993, -0.40032,
-0.13737, -0.13632, -0.10879, -0.051972, 0.004639, 0.032592, 0.019495, -0.041377, -0.13965, -0.22596, -0.24048, -0.17286, -0.069271, 0.021251, 0.086084, 0.13247, 0.15916, 0.16461, 0.15847, 0.13971, 0.087965, 0.0018166, -0.076758, -0.10529, -0.097318, -0.10696, -0.16054, -0.23302, -0,
-0.19784, -0.19733, -0.17619, -0.13449, -0.097037, -0.082022, -0.093423, -0.13905, -0.21849, -0.28969, -0.28507, -0.17443, 0.0037214, 0.17392, 0.27904, 0.30593, 0.27207, 0.20888, 0.14794, 0.096674, 0.037798, -0.029382, -0.067654, -0.046375, 0.0065728, 0.02643, -0.015667, -0.086594,
-0.18742, -0.18865, -0.17585, -0.15224, -0.1408, -0.15176, -0.17588, -0.21186, -0.26409, -0.30379, -0.26949, -0.12425, 0.098176, 0.30706, 0.41874, 0.41149, 0.32075, 0.20105, 0.095799, 0.018503, -0.042017, -0.08726, -0.091919, -0.038032, 0.044257, 0.093622, 0.079881, 0.032474, -0.002,
-0.15803, -0.15997, -0.15054, -0.13533, -0.14098, -0.17727, -0.222, -0.25648, -0.28226, -0.28597, -0.22479, -0.069712, 0.14801, 0.34112, 0.42647, 0.38652, 0.26665, 0.12628, 0.0049819, -0.083865, -0.14269, -0.16971, -0.15096, -0.080521, 0.014534, 0.084501, 0.10237, 0.089934, 0.084473,
-0.13386, -0.13574, -0.12633, -0.11281, -0.12742, -0.18381, -0.25049, -0.29075, -0.29976, -0.27881, -0.20901, -0.076616, 0.091248, 0.22811, 0.27347, 0.22174, 0.11692, 0.0043224, -0.096072, -0.17817, -0.23274, -0.24609, -0.20949, -0.12998, -0.035581, 0.036816, 0.072409, 0.093076, 0.1,
-0.096231, -0.095252, -0.084914, -0.076263, -0.10291, -0.17763, -0.26302, -0.31283, -0.31985, -0.29731, -0.24488, -0.15931, -0.059464, 0.014267, 0.029215, -0.008073, -0.061189, -0.10821, -0.1583, -0.21987, -0.27205, -0.28038, -0.23154, -0.14485, -0.057246, 0.0019832, 0.035572, 0.07,
-0.029161, -0.018049, -0.0014796, 0.00061282, -0.040614, -0.12876, -0.22427, -0.28469, -0.30784, -0.31218, -0.30028, -0.26579, -0.21759, -0.18062, -0.1727, -0.18055, -0.17263, -0.1458, -0.13802, -0.17735, -0.23564, -0.25351, -0.20348, -0.11288, -0.032074, 0.010178, 0.030429, 0.0713,
0.029328, 0.060219, 0.095729, 0.10312, 0.060382, -0.024579, -0.11584, -0.18536, -0.23925, -0.29113, -0.32886, -0.33045, -0.2979, -0.2587, -0.23471, -0.21235, -0.15844, -0.077064, -0.02636, -0.053462, -0.12816, -0.16891, -0.13067, -0.044014, 0.02902, 0.057718, 0.065138, 0.09684, 0.16372, 0.22421,
0.029377, 0.085108, 0.15042, 0.17993, 0.15591, 0.093052, 0.019073, -0.054508, -0.13958, -0.23791, -0.31505, -0.33051, -0.28459, -0.21842, -0.16797, -0.12285, -0.044964, 0.062684, 0.13237, 0.10449, 0.0089851, -0.05781, -0.037571, 0.037765, 0.099591, 0.1181, 0.11907, 0.14318, 0.19598, 0.24243,
-0.0064394, 0.067859, 0.15784, 0.21005, 0.208, 0.16824, 0.11131, 0.0381, -0.065228, -0.19042, -0.28698, -0.30264, -0.23871, -0.14805, -0.07787, -0.020555, 0.06564, 0.1803, 0.25303, 0.21924, 0.10867, 0.024639, 0.031674, 0.096605, 0.14843, 0.16034, 0.16007, 0.18234, 0.22686, 0.26354 };
static const int datasize = 30;
const Eigen::Matrix<double, datasize, datasize, Eigen::RowMajor> m1(m1data);

using State = std::pair<int, int>;

bool reachable(State state, State action, int dimension)
{
	int f = state.first + action.first;
	int s = state.second + action.second;
	return (f < dimension && f >= 0 && s < dimension && s >= 0);
}

State genState(int i)
{
	switch(i)
	{
	case 0: return std::make_pair(-1, 0);
	case 1: return std::make_pair(0, -1);
	case 2: return std::make_pair(1, 0);
	case 3: return std::make_pair(0, 1);
	}
	return std::make_pair(0, 0);
}

State randomAction(State state, int dimension)
{
	State output;
	do
	{
		std::uniform_int_distribution<> dis(0, 3);
		output = genState(dis(gen));
	} while(!reachable(state, output, dimension));

	return output;
}
double value(const Eigen::Matrix<double, datasize, datasize>& poly, int x, int y)
{
	return poly(x, y);
	double value = 0;
	for (int i = 0; i < 4; i++)
	{
		for (int j = 0; j < 4; j++)
		{
			value += poly(i, j)*pow(x, i)*pow(y, j);
		}
	}
	return value;
}
double maxReward(const Eigen::MatrixXd& Q, State state, int dimension, State* newState = nullptr)
{
	double maxR = -std::numeric_limits<double>::infinity();
	for(int i(0); i < 4; i++)
	{
		State action = genState(i);
		if(!reachable(state, action, dimension)) continue;

		State s2 = std::make_pair(state.first + action.first, state.second + action.second);
		double rec = Q(dimension*state.first + state.second, dimension*s2.first + s2.second);
		if(maxR < rec)
		{
			maxR = rec;
			if(newState)
				*newState = s2;
		}
	}
	return maxR;
}

bool isTreasure(const State& state, int dimension)
{
	return state.first == dimension - 1 && state.second == dimension - 1;
}

int main()
{
	const double alpha = 1;
	const double gamma = 0.9;
	const int dimension = datasize;
	const int qdim = dimension*dimension;
	/*coefficients du polynome.
	n°ligne = puissance de x
	n°colonne = puissance de y*/
	

	//creation matrices de qualité
		//exploration pure
	Eigen::MatrixXd Q(qdim, qdim);
		//Exploration + exploitation (proba constante)
	Eigen::MatrixXd Q2(qdim, qdim);
	//initialisation des matrices
	Q.setConstant(0);
	Q2.setConstant(0);
	//creation de l'état (position de l'agent)
	State state [2];

	std::uniform_int_distribution<> dis(0, dimension - 1);
	//initialisation aléatoire de la position
	state[0].first = dis(gen);	
	state[0].second = dis(gen);
	state[1].first = dis(gen);
	state[1].second = dis(gen);

	// Récompense globale itération
	double reward[2];
	// Vecteur évolution de la récompense
	std::vector<std::pair<double, int>> R[2];

	std::pair<int, int> action[2];
	for (int i = 0; i < 1e8; i++)
	{
		//choix de l'action au hasard
		action[0] = randomAction(state[0], dimension);

		//choix de  l'action (exploration + exploitation)
		std::uniform_int_distribution<> expl(0, 100);
		double temp = expl(gen);
		if (temp >= 5) 
		{
			// choix de l'action au hasard
				action[1] = randomAction(state[1], dimension);
		}
		else //optimale
		{
			State newState;
			maxReward(Q2, state[1], dimension, &newState);
			action[1] = std::make_pair(newState.first - state[1].first, newState.second - state[1].second);
		}


		//récompense
		for (int j = 0; j < 2 ; j++)
		{
			int s = dimension * state[j].first + state[j].second;
			std::pair<int, int> S;
			S.first = state[j].first + action[j].first;
			S.second = state[j].second + action[j].second;
			int nextState = dimension * S.first + S.second;
			double r;
			if (isTreasure(S, dimension))
				r = 10000;
			else
			{
				r = - std::abs(value(m1, state[j].first, state[j].second) - value(m1, S.first, S.second));
				
			}

			if (j == 0)
			{
				Q(s, nextState) = (1 - alpha)*Q(s, nextState) + gamma*(r + maxReward(Q, S, dimension));
				reward[0] += r;
			}
			else
			{
				Q2(s, nextState) = (1 - alpha)*Q2(s, nextState) + gamma*(r + maxReward(Q2, S, dimension));
				reward[1] += r;
			}

			state[j] = S;

			if (isTreasure(state[j], dimension))
			{
				std::cout << "finished" << std::endl;
				state[j] = std::make_pair(dis(gen), dis(gen));
				if (j == 0)
				{
					R[0].push_back(std::make_pair(reward[0], i));
					reward[0] = 0;
				}
				if (j == 1)
				{
					R[1].push_back(std::make_pair(reward[1], i));
					reward[1] = 0;
				}
			}
		}
	}
	std::ofstream file("log_exploration.csv");
	std::ofstream file2("log_combinaison.csv");
	for (int i = 0; i < 2; i++)
	{
		state[i] = std::make_pair(0, 0);
		int maxIter = 200;
		do
		{
			if (i == 0)
			{
				file << state[i].first << "," << state[i].second << std::endl;
				std::cout << maxReward(Q, state[i], dimension, &state[i]) << std::endl;
			}
			if (i == 1)
			{
				file2 << state[i].first << "," << state[i].second << std::endl;
				std::cout << maxReward(Q2, state[i], dimension, &state[i]) << std::endl;
			}

			
		} while (!isTreasure(state[i], dimension) && maxIter--);

		
	}
	file.close();
	file2.close();
	std::ofstream file3("recompense_exploration.csv");
	std::ofstream file4("recompense_combinaison.csv");
	for (unsigned int k = 0; k < R[0].size() - 1; k++)
	{
			file3 << R[0][k].first << "," << R[0][k].second << std::endl;
	}
	for (unsigned int l = 0; l < R[1].size() - 1; l++)
	{
			file4 << R[1][l].first << "," << R[1][l].second << std::endl;
	}
	file3.close();
	file4.close();
	
	system("pause");
	return 0;
}